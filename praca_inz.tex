
\documentclass[a4paper]{article}

\usepackage[polish]{babel}
\usepackage{lmodern} %Type1-font for non-english texts and characters
\usepackage{amsmath}%
\usepackage{amsfonts}%
\usepackage{graphicx}
\usepackage[T1]{fontenc}
\usepackage{polski}
\usepackage[cp1250]{inputenc}
\usepackage{svg}
\usepackage{float}
\usepackage{enumerate}
\usepackage{indentfirst}
\usepackage{url}



%-------------------------------------------


\setlength{\textwidth}{\paperwidth}
\addtolength{\textwidth}{-5cm}
\setlength{\textheight}{\paperheight}
\addtolength{\textheight}{-5cm}
\setlength{\oddsidemargin}{0cm}
\setlength{\evensidemargin}{0cm}
\topmargin -1.25cm
\footskip 1.4cm
\graphicspath{ {./fig/} }



\title{POLITECHNIKA POZNAÑSKA
\vspace{0.2cm}

\Large WYDZIA£ AUTOMATYKI, ROBOTYKI I ELEKTROTECHNIKI

INSTYTUT ROBOTYKI I INTELIGENCJI MASZYNOWEJ

ZAK£AD STEROWANIA I ELEKTRONIKI PRZEMYS£OWEJ
\vspace{1cm}
\begin{figure}[H]
\centering
\includegraphics{logo.png}   
\end{figure} 
\vspace{1cm}
PRACA DYPLOMOWA 

IN¯YNIERSKA
\vspace{1cm}

Mikroprocesorowy kaskadowy uk³ad regulacji pr¹du, prêdkoœci i po³o¿enia dla napêdu z silnikiem BLDC
\vspace{2cm}
\begin{flushleft}
\normalsize

\hspace{8cm}PROMOTOR:

\hspace{8cm}DR IN¯. DOMINIK £UCZAK
\vspace{0.2cm}

\scriptsize \hspace{8cm}POTWIERDZAM PRZYJÊCIE PRACY
\vspace{0.5cm}

\hspace{8cm}...........................


\scriptsize \hspace{8cm}DATA I PODPIS PROMOTORA
\end{flushleft}
\vspace{0.5cm}
}

\author{MATEUSZ SEMK£O}

\date{2020-10-25}



\begin{document}
\maketitle
\newpage
\tableofcontents
\newpage


\section{Wstêp}

Tematem pracy in¿ynierskiej jest\textit{Mikroprocesorowy kaskadowy uk³ad regulacji pr¹du, prêdkoœci i po³o¿enia dla napêdu z silnikiem BLDC}. Zainteresowanie i zdobyta wiedza z zakresu automatyki, mikroprocesorów i maszyn elektrycznych  spowodowa³a chêæ stworzenia  uk³adu napêdowego dla silnika elektrycznego przy wykorzystaniu mo¿liwoœci mikrokontrolerów i stawieniu czo³a trudnoœciom przy jego praktycznej realizacji.  

Celem jest pokazanie mo¿liwoœci wykorzystania mikroprocesora jako jednego ze sposobów na realizacje uk³adu regulacji dla silnika BLDC. Zakres pracy obejmuje:
\begin{itemize}
\item{Dobór i uruchomienie mikroprocesorowej p³yty rozwojowej STM32 dla wybranego uk³adu napêdowego z silnikiem BLDC}
\item{Dobór parametrów regulatorów PID. Wykorzystanie regulatorów dostêpnych w bibliotece CMSIS-DSP}
\item{Opracowanie interfejsu u¿ytkownika pozwalaj¹cego na parametryzacjê i monitoring pracy napêdu w czasie rzeczywistym}
\item{Analiza mo¿liwoœci wykonania procedury automatycznego strojenia uk³adu napêdowego}
\end{itemize}

Silnik BLDC (ang. Burshless Direct Current) nale¿y do rodziny silników z magnesami trwa³ymi. Charakteryzuje siê sta³ym momentem elektromagnetycznym w szerokim zakresie prêdkoœci obrotowej. Brak komutatora zapewnia wiêksz¹ sprawnoœæ i ¿ywotnoœæ silnika. Z powodu wielu zalet czêsto wykorzystywane  w automatyce i robotyce.

Silnik  ze wzglêdu na konstrukcje wymaga bardziej z³o¿onego sposobu sterowania w porównaniu z silnikiem pr¹du sta³ego. W tym celu wykorzystana zosta³a metoda FOC (ang. Field-orient control). Jest to jedna z powszechnie stosowanych technik w uk³adach regulacji trójfazowych silników synchronicznych z magnesami trwa³ymi. Pozwala ona sprowadziæ wartoœci pr¹dów fazowych stojana z trójwymiarowego uk³ad wspó³rzêdnych do wiruj¹cego uk³adu o dwóch wspó³rzêdnych biegn¹cego synchronicznie  z wektorem strumienia wirnika. Uzyskujemy w ten sposób dostêp do wartoœci sta³ych, które mo¿na umieœciæ bezpoœrednio w pêtlach regulatorów PID i uzyskaæ mo¿liwoœæ regulacji pr¹dem, prêdkoœci¹ i po³o¿eniem.

 Do modulacji szerokoœci impulsów wykorzystano metodê SVPWM (ang. Space Vector Pulse Width Modulation) . W porównaniu z alternatywn¹ modulacj¹ SPWM (ang. Sine Pulse Width Modulation) cechujê siê mniejszymi zniekszta³ceniami sygna³u spowodowanych przez wy¿sze harmoniczne i wykorzystujê wiêkszy przedzia³ napiêcia zasilania. Przekszta³ca ona stany logiczne tranzystorów przekszta³tnika w wektory, które tworz¹ razem kszta³t szeœciok¹ta i dziel¹ przestrzeñ na szeœæ sektorów. Wektor referencyjny jest generowany w wyniku aktywowania dwóch s¹siaduj¹cych wektorów z przestrzeni stanu w okreœlonej sekwencji i czasie. W wyniku tych operacji formowane s¹ trzy sygna³y PWM dla trzech par tranzystorów przekszta³tnika energoelektronicznego. 
 
G³ównymi elementami uk³adu jest zestaw prototypowy STM32 B G431B-ESC1 oraz STM32 Nucleo F746ZG. B G431B-ESC1 wyposa¿ony w mikrokontroler STM32G431CB, rdzeñ ARM Cortex M4, trójfazowy przekszta³tnik energoelektroniczny jest uk³adem realizuj¹cym proces regulacji pr¹du, prêdkoœci i po³o¿enia wirnika.  Nucleo F746ZG odpowiada za komunikacjê miêdzy regulatorem a interfejsem u¿ytkownika. Aplikacja u¿ytkownika jest napisana w jêzyku python i ³¹czy z p³yt¹ Nucleo F746ZG za poœrednictwem przewodu sieciowego przy wykorzystaniu protok³u TCP/IP. Informacje przekazywane s¹ w postaci ³añcuchów znaków w formacie JSON.  
Specyfika uk³adu pomiarowego pr¹du wymaga aby pomiar by³ wykonywany, gdy wszystkie tranzystory grupy górnej by³y wy³¹czone a grupy dolnej w³¹czone. Wyzwolenie nastêpuje w osi symetrii ka¿dego okresu sygna³u PWM.  W funkcji obs³ugi zdarzenia przeprowadzane s¹ wszystkie operacje zwi¹zane z regulacj¹ i modulacj¹ sygna³ów.

W uk³adzie zdefiniowane s¹ cztery regulatory PID: pr¹du, strumienia magnetycznego wirnika skojarzonego ze stojanem, prêdkoœci i po³o¿enia wirnika. S¹ one po³¹czone ze sob¹ w sposób kaskadowy. Pêtle regulacji s¹ zagnie¿d¿one jedna w drugiej, gdzie wyjœcie z regulatora pêtli zewnêtrznej ustala wartoœæ zadan¹ pêtli wewnêtrznej. Ró¿ni¹ siê one czêstotliwoœci¹ obliczeñ. 
     


\newpage


\section{Silnik BLDC}
\subsection{Budowa}
Bezszczotkowe silniki z magnesami trwa³ymi mo¿na podzieliæ na silniki pr¹du sta³ego BLDC oraz synchroniczne silniki pr¹du przemiennego PMSM (ang. Permanent Magnet Synchronous Motor). Ró¿ni¹ siê one kszta³tem przebiegu si³y elektromotorycznej. Na rysunku \ref{fig:1} przedstawiono przebiegi indukowanego napiêcia, pr¹du i momentu elektromagnetycznego dla silnika BLDC i PMSM. \cite{goryca2012metody}

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{przebieg_SEM.png} 
\caption{Przebiegi si³y elektromotorycznej E, pr¹du I i momentu T dla jednej fazy dla:
 a) silnika PMSM, b) silnika BLDC \cite{zajkowski2013sterowanie} }
\label{fig:1}
\end{figure} 

Istnieje wiele odmian silników BLDC ró¿ni¹cych siê budow¹, konstrukcj¹ obwodów magnetycznych, rozk³adem indukcji i kszta³tem si³ elektromotorycznych. Uzwojenie  twornika jest zazwyczaj w stojanie i jest uzwojeniem trójfazowym. Kszta³t magnesów trwa³e umieszczonych na wirniku zapewniaj¹ sta³¹ wartoœæ indukcji w szczelinie maszyny i trapezoidalny kszta³t si³y elektromotorycznej. Rysunek \ref{fig:2} i \ref{fig:3} przedstawia budowê stojana i wirnika przyk³adowego silnika bezszczotkowego. \cite{krykowski}

\begin{figure}[H]
\centering
\includegraphics[width=5cm]{stojan.png}   
\caption{Stojan silnika BLDC \cite{goryca2012metody}}
\label{fig:2}
\end{figure} 

\begin{figure}[H]
\centering
\includegraphics[width=5cm]{wirnik.png}   
\caption{Wirnik silnika BLDC \cite{goryca2012metody}}
\label{fig:3}
\end{figure} 

\subsection{Zasada dzia³ania}
Silnik elektryczny przetwarza dostarczon¹ energiê elektryczn¹ w energiê mechaniczn¹. Ruch wirnika wystêpuje, gdy zasilaj¹c odpowiednie uzwojenia stojana nastêpuje pojawienie siê wiruj¹cego pola elektromagnetycznego, które oddzia³uje na pole magnetyczne wirnika i wprawia go w ruch. Strumienie magnetyczne wirnika i stojana powinny byæ wzglêdem siebie nieruchome. W klasycznym silniku pr¹du sta³ego powy¿szy warunek jest spe³niony przez odpowiednie umiejscowienie szczotek komutatora wzglêdem pola stojana.
Z powodu braku klasycznego komutatora w silniku BLDC zapewnienie wirowania strumienia stojana synchronicznie z wirnikiem jest realizowane przez odpowiednie prze³¹czanie uzwojeñ. W tym celu 
wykorzystuje siê przetwornik energoelektroniczny, którego zadaniem jest odpowiednie usytuowanie strumieni wzglêdem siebie, poprzez prze³¹czanie tranzystorami mocy. Aby to zrealizowaæ potrzebna jest wiedza o aktualnym po³o¿eniu k¹ta obrotu wirnika, wykorzystuj¹c czujniki Halla lub przetworniki obrotowo-impulsowe.\cite{krykowski}

Na rysunku \ref{fig:4} pokazano uproszczony schemat uk³adu sterowania i zasilania silnika BLDC.
 



\begin{figure}[H]
\centering
\includegraphics[width=8cm]{sterowanie_BLDC.png}   
\caption{Uproszczony schemat uk³adu sterowania i zasilania silnika \cite{domoracki2005silniki}}
\label{fig:4}
\end{figure} 


\subsection{Sposoby sterowania}

Silnik bezszczotkowy  nie posiada konwencjonalnego komutatora , wiêc stale nale¿y kontrolowaæ po³o¿enie wirnika oraz zastosowaæ odpowiedni sposób za³¹czania uzwojeñ. Istniej¹ trzy podstawowe strategie komutacji \cite{krykowski}:
\begin{itemize}
\item komutacja trapezoidalna – prze³¹czanie uzwojeñ odbywa siê w sposób dyskretny wiêc nie jest potrzebny ci¹g³y pomiar k¹ta obrotu wa³u. Najczêœciej wykorzystujê siê czujniki Halla, które s¹ rozmieszczone w odstêpach 120 stopni lub bezczujnikowe obliczanie po³o¿enia wirnika. Zmiana stanu jednego z czujników inicjujê rozpoczêcie zmiany zasilania uzwojeñ stojana. Zasilane s¹ jednoczeœnie tylko dwa uzwojenia.
\item komutacja sinusoidalna – prze³¹czanie uzwojeñ odbywa siê w sposób quasi-ci¹g³y. Pr¹dy fazowe i si³y elektromotoryczne powinny byæ sinusoidalne. Przekszta³tnik energoelektroniczny pe³ni funkcje falownika. Do pomiaru po³o¿enia wykorzystuje siê przetwornik impulsowo-obrotowy lub algorytm do bezczujnikowego obliczania k¹ta obrotu wirnika.  Zasilane s¹ jednoczeœnie  trzy  uzwojenia. 
\item zastosowanie algorytmu FOC (ang. Field Orient Control).\\
 Metoda ta zosta³a wykorzystana w niniejszej pracy i opisana w rozdziale \ref{chapter:1}.
\end{itemize}


\subsection{Model matematyczny}
Wartoœæ momentu elektromagnetycznego wytworzonego dla p³askiego fragmentu si³y elektromotorycznej przez pr¹d p³yn¹cy w jednym uzwojeniu fazowym \cite{krykowski}:

\begin{equation} \label{eqn:1}
 Me=p \psi _{p} i 
\end{equation}


Me - moment elektromagnetyczny

p - liczba par biegunów

$\psi _{p}$ -strumieñ magnetyczny wytworzony przez wirnik a skojarzony z uzwojeniem stojana

i - pr¹d uzwojenia stojana 
\\

Chwilowa wartoœæ strumienia skojarzonego z k-tym uzwojeniem zmieniaj¹ca siê w funkcji obrotu wirnika \cite{krykowski}:
\begin{equation} \label{eqn:2}
 \psi _{k}(\theta _{e})=\psi _{p}f(\theta _{e})
\end{equation}

$\theta _{e}$ - elektryczny k¹t po³o¿enia wirnika
\\

£¹cz¹c powy¿sze wyra¿enia \ref{eqn:1} i \ref{eqn:2} uzyskujemy moment elektromagnetyczny dla k-tej fazy \cite{krykowski}:
 
 
\begin{equation} \label{eqn:3}
 M_{ek}=p \psi _{k}(\theta _{e}) i 
\end{equation} 

Moment ca³kowity jest równy sumie momentów elektromagnetycznych\cite{krykowski}:

\begin{equation} \label{eqn:4}
 M_{e}=\sum_{k=1}^{3} M_{ek}
\end{equation} 

Równanie ruch ma postaæ:
\begin{equation} \label{eqn:5}
 M_{e}=J \frac{d\omega}{dt}+M
\end{equation} 

J - moment bezw³adnoœci

M - moment oporowy
\\

Wzór dla p³askiego odcinka si³y elektromotorycznej\cite{krykowski}:

\begin{equation} \label{eqn:6}
 E_{p}=p \psi _{p}\omega
\end{equation} 

$\omega$ - prêdkoœæ obrotowa wirnika 
\\

Wyra¿enie opisuj¹ce si³ê elektromotoryczn¹ indukowan¹ w k-tym uzwojeniu\cite{krykowski}:

\begin{equation} \label{eqn:7}
 E_{k}=p \psi _{k}(\theta _{e})\omega
\end{equation} 
\\

Silnik BLDC mo¿na traktowaæ jako szczególny przypadek silnika synchronicznego.
Schemat zastêpczy silnika trójfazowego z magnesami trwa³ymi przedstawiony na rysunku \ref{fig:5}.

\begin{figure}[H]
\centering
\includegraphics[width=9cm]{model_silnik.png}   
\caption{Schemat silnika synchronicznego z magnesami trwa³ymi}
\label{fig:5}
\end{figure} 


M - indukcyjnoœæ wzajemna

L - indukcyjnoœæ w³asna

R - rezystancja uzwojeñ

E - si³a elektromotoryczna
\\

Zak³adaj¹c, ¿e indukcyjnoœci w³asne i rezystancje s¹ równe:\\
\begin{equation} \label{eqn:8}
 L=L_{A}=L_{B}=L_{C}
 R=R_{A}=R_{B}=R_{C}
\end{equation}


oraz indukcyjnoœci wzajemne równie¿ to ca³kowita indukcyjnoœæ  jednej fazy jest równa:

\begin{equation} \label{eqn:9}
 L_{S}=L-M
\end{equation}

Otrzymujemy wyra¿enie \cite{krykowski}:

\begin{equation} \label{eqn:10}
\begin{bmatrix}
U_{A}  \\
U_{B}  \\
U_{C}  \\
\end{bmatrix}
= R
\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
I_{A}  \\
I_{B}  \\
I_{C}  \\
\end{bmatrix}
+L_{S}\frac{d}{dt}
\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
I_{A}  \\
I_{B}  \\
I_{C}  \\
\end{bmatrix}
+
\begin{bmatrix}
E_{A}  \\
E_{B}  \\
E_{C}  \\
\end{bmatrix}
\end{equation} 

oraz

\begin{equation} \label{eqn:11}
\frac{d}{dt}
\begin{bmatrix}
I_{A}  \\
I_{B}  \\
I_{C}  \\
\end{bmatrix}
= - \frac{R}{L}
\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
I_{A}  \\
I_{B}  \\
I_{C}  \\
\end{bmatrix}
-\frac{1}{L}
\begin{bmatrix}
E_{A}  \\
E_{B}  \\
E_{C}  \\
\end{bmatrix}
+\frac{1}{L}
\begin{bmatrix}
U_{A}  \\
U_{B}  \\
U_{C}  \\
\end{bmatrix}
\end{equation}
\\

Wykorzystuj¹c równanie \ref{eqn:3}, \ref{eqn:5}, \ref{eqn:7}, \ref{eqn:11} i zapis \ref{eqn:12} w postaci równaæ stanu uzyska siê pe³en model idealnego silnika o trapezoidalnej sile elektromotorycznej \cite{krykowski}:

\begin{equation} \label{eqn:12}
 \hat{x}=Ax+Bu
\end{equation} 

gdzie:

\begin{equation} \label{eqn:13}
 x=
\begin{bmatrix}
I_{A}  & I_{B}  & I_{C} & \omega & \theta
\end{bmatrix}^{T}
\end{equation} 

\begin{equation} \label{eqn:14}
 u=
\begin{bmatrix}
U_{A}  & U_{B}  & U_{C} & M
\end{bmatrix}^{T}
\end{equation} 

\begin{equation} \label{eqn:15}
 A=
\begin{bmatrix}
-\frac{R}{L}  & 0  & 0 & -p\psi_{A}(\theta_{e})/L & 0\\
0  & -\frac{R}{L}  & 0 & -p\psi_{B}(\theta_{e})/L & 0\\
0  & 0  & -\frac{R}{L} & -p\psi_{C}(\theta_{e})/L & 0\\
-p\psi_{A}(\theta_{e})/J & -p\psi_{B}(\theta_{e})/J & -p\psi_{C}(\theta_{e})/J & -B/J & 0 \\
0 & 0 & 0 & 1 & 0
\end{bmatrix}
\end{equation} 


\begin{equation} \label{eqn:16}
 B=
\begin{bmatrix}
1/L & 0 & 0 & 0 \\
0 & 1/L & 0 & 0 \\
0 & 0 & 1/L & 0 \\
0 & 0 & 0 & 1/L \\
0 & 0 & 0 & 0 \\
\end{bmatrix}
\end{equation} 




\subsection{Charakterystyka silnika - wady, zalety}
Brak konwencjonalnego komutatora wyd³u¿a ¿ywotnoœæ silnika i nie wymaga konserwacji.  Brak szczotek powoduje mniejsze tarcie, brak negatywnych skutków iskrzenia podczas komutacji oraz mniejsze zaburzenia elektromotoryczne. W porównaniu ze szczotkowym silnikiem pr¹du sta³ego uzwojenia twornika s¹ zazwyczaj umieszczone w zewnêtrznej czêœci silnika, co zapewnia lepsze odprowadzanie ciep³a do otoczenia. Magnesy trwa³e maj¹ bardzo ma³¹ przenikalnoœæ magnetyczn¹ zbli¿on¹ do przenikalnoœci magnetycznej powietrza. Reaktancja twornika jest pomijalnie ma³a dziêki czemu osi¹gany jest du¿y moment elektromagnetyczny. Do wad nale¿y zaliczyæ bardziej skomplikowany sposób sterowania silnikiem przez zastosowanie komutatora elektronicznego w postaci przekszta³tnika energoelektronicznego do cyklicznego zasilania uzwojeñ twornika. 




\section{Field Orient Control}
 \label{chapter:1}
 
 Algorytm wektorowy FOC (ang. Field Orient Control) przedstawiony schematycznie na rysunku \ref{fig:6} jest jedn¹ z powszechnie stosowanych metod sterowania silników trójfazowych z magnesami trwa³ymi. Polega na bezpoœrednim sterowaniu wiruj¹cym polem stojana.  Pozwala uzyskaæ dok³adn¹ i dynamiczn¹ regulacjê momentu elektrodynamicznego, prêdkoœci i po³o¿enia wirnika.\cite{Przepiorkowski2010FOC}
 \\
 
\begin{figure}[H]
\centering
\includegraphics[width=14cm]{diagramFOC.png}   
\caption{Algorytm FOC \cite{Frick2018BLDC}}
\label{fig:6}
\end{figure} 
 
Metoda FOC steruje pr¹dami fazowymi stojana reprezentowanymi w postaci wektora. Czujniki pr¹du dostarczaj¹ informacjê zwrotn¹ o aktualnych pr¹dach fazowych. Za pomoc¹ transformaty Clark’a, wyra¿ona za pomoc¹ wzoru   \ref{eqn:17} i pokazana na rysunku \ref{fig:7},   przekszta³ca trójwymiarowy uk³ad wspó³rzêdnych, w którym opisane s¹ pr¹dy fazowe Ia,Ib,Ic na uk³ad ograniczony tylko do dwóch wspó³rzêdnych otrzymuj¹c wiruj¹cy wektor na p³aszczyŸnie. Znaj¹c aktualne po³o¿enie wirnika i korzystaj¹c z transformaty Park’a, wyra¿ona we wzorze \ref{eqn:18} i pokazana na rysunku \ref{fig:8}, uzyskujemy wiruj¹cy uk³ad wspó³rzêdnych . Operacja ta pozwala  na przekszta³cenie wiruj¹cego wektora pr¹du na dwie sk³adowe sta³e Id, Iq. Id jest wielkoœci¹ odpowiadaj¹c¹ strumieniowi magnetycznemu a Iq momentowi elektromagnetycznemu silnika. Minimalizuj¹c wartoœæ Id zapewniamy k¹t prosty miêdzy polem magnetycznym stojana i wirnika oraz uzyskujemy najwiêksza sprawnoœæ silnika.\cite{Przepiorkowski2010FOC}
\cite{europe1998field}
\\


\begin{figure}[H]
\centering
\includegraphics[width=7cm]{clark.png}   
\caption{Transformata Clark'a \cite{europe1998field}}
\label{fig:7}
\end{figure} 

Wyra¿enie opisuj¹ce transformatê Clark'a \cite{Przepiorkowski2010FOC}:

\begin{equation} \label{eqn:17}
\left\{ \begin{array}{ll}
I_{\alpha}=I_{A}\\
I_{\beta}=\frac{1}{\sqrt{3}}I_{A}+\frac{2}{\sqrt{3}}I_{B} \\
\end{array} \right. 
\end{equation} 
\\




\begin{figure}[H]
\centering
\includegraphics[width=8cm]{park.png}   
\caption{Transformata Park'a \cite{europe1998field}}
\label{fig:8}
\end{figure} 

Wyra¿enie opisuj¹ce transformatê Park'a \cite{Przepiorkowski2010FOC}:

\begin{equation} \label{eqn:18}
\left\{ \begin{array}{ll}
I_{d}=I_{\alpha}cos(\theta)+I_{\beta}sin(\theta)\\
I_{q}=I_{\alpha}sin(\theta)+I_{\beta}cos(\theta)
\end{array} \right. 
\end{equation} 
\\

 
Algorytm FOC pozwala uzyskaæ z trzech przebiegów pr¹dów przemiennych dwie sk³adowe sta³opr¹dowe. Pozwala to na zastosowanie dwóch regulatorów PID dla sk³adowej Id oraz Iq uzyskuj¹c regulator pr¹du. Regulacje prêdkoœci obrotowej i po³o¿enia wirnika mo¿na zrealizowaæ przez dodanie kolejnych regulatorów PID do ga³êzi ze sta³¹ Iq. 
 

Zastosowanie odwrotnych transformat pozwala na sprowadzenie sk³adowych sta³ych do trzch przebiegów sinusoidalnych i wprowadzenie ich wartoœci na kolejny blok algorytmu FOC zwany SVPWM (ang. Space Vector Pulse Width Mudulation) opisany w rozdziale \ref{chapter:2}. Blok ten steruje bramkami tranzystorów przetwornika, aby uzyskaæ w uzwojeniach takie przebiegi pr¹dów, które bêd¹ generowa³y odpowiedni¹ amplitudê i prêdkoœæ wirowania pola magnetycznego stojana wzglêdem pola wirnika. Rysunek \ref{fig:9} przedstawia kolejnoœæ dokonywanych transformacji.

 \begin{figure}[H]
\centering
\includegraphics[width=14cm]{transformacje.png}   
\caption{Transformacje w algorytmie FOC \cite{Frick2018BLDC}}
\label{fig:9}
\end{figure}  

\section{Modulacja wektorowa - SVPWM}
 \label{chapter:2}
 
 Wydajnoœæ pr¹dowa mikrokontrolera jest niewystarczaj¹ca aby zasiliæ silnik, dlatego uzwojenia stojana s¹ bezpoœrednio pod³¹czone do przekszta³tnika energoelektronicznego zasilanego napiêciem sta³ym. Schemat przekszta³tnika przedstawia rysunek \ref{fig:4}. SVPWM jest meted¹ pozwalaj¹c¹ okreœliæ, sekwencje i czas trwania za³¹czeñ tranzystorów. W porównaniu z konwencjonaln¹ metod¹ SPWM (ang. Sine Pulse Width Modulation) do sterowania silników synchronicznych, pozwala na wykorzystanie szerszego zakresu napiêcia zasilania i zmniejszenia zniekszta³ceñ spowodowanych przez wy¿sze harmoniczne.\cite{mansour2015novel}

 Elementami wykonawczymi s¹ tranzystory mocy, które mo¿na podzieliæ na grupê trzech zaworów dodatnich i ujemnych. W ka¿dej chwili aktywne s¹ trzy zawory. W ten sposób uzyskujemy osiem mo¿liwych kombinacji za³¹czeñ tranzystorów, które generuj¹ osiem wektorów (szeœæ wektorów aktywnych, dwa wektory zerowe lub nieaktywne) i dziel¹ przestrzeñ na szeœæ sektorów  - schematycznie przedstawiono na rysunku \ref{fig:10}. 

 \begin{figure}[H]
\centering
\includegraphics[width=7cm]{hexagon.png}   
\caption{Wektory w przestrzeni stanu i podzia³ na sektory \cite{Frick2018BLDC}}
\label{fig:10}
\end{figure} 

Maksymalne napiêcie fazowe jest równe 2/3 VDC. Aby uzyskaæ nieodkszta³cony przebieg sinusoidalny maksymalne napiêcie szczytowe jest ograniczone do wartoœci promienia  okrêgu
wpisanego w szeœciok¹t i jest równe $ V_{max}=V_{dc}  \sqrt{3}/2$. Powy¿sze za³o¿enie przedstawiono na rysunku \ref{fig:11}.\cite{mansour2015novel}

 \begin{figure}[H]
\centering
\includegraphics[width=8cm]{svpwm_max.png}   
\caption{Maksymalna d³ugoœæ wektora  \cite{Frick2018BLDC}}
\label{fig:11}
\end{figure}  
 
Na przyk³adzie rysunku \ref{fig:12} zosta³ objaœniony sposób generowania dowolnego wektora wed³ug metody SVPWM.  Wektor Vx znajdujê siê w sektorze pierwszym i jest wynikiem dodania do siebie trzech wektorów $V_{A}$, $V_{B}$, $V_{0}$, gdzie $V_{0}$ jest wektorem zerowym.\cite{mansour2015novel}


 \begin{figure}[H]
\centering
\includegraphics[width=7cm]{svpwm.png}   
\caption{Generowanie wektora $V_{X}$ \cite{mansour2015novel}}
\label{fig:12}
\end{figure} 

Dla sektora pierwszego wektor $V_{A}$ jest zgodny z kierunkiem wektora $V_{1}$ a wektor $V_{B}$ z kierunkiem wektora $V_{2}$. D³ugoœæ obu wektorów jest determinowana przez czas, w którym dana sekwencja zaworów (reprezentowana przez okreœlony wektor V1,…,V6) jest aktywna.\cite{mansour2015novel} 

Z równania \cite{mansour2015novel}:

\begin{equation} \label{egn:19}
\left\{ \begin{array}{ll}
|V_{x}| cos(\alpha)\times T_{s} = V_{DC} \times T_{A} + V_{DC} \times cos(\pi/3) \times T_{B}\\
|V_{x}| sin(\alpha)\times T_{s} = V_{DC} \times sin(\pi/3) \times T_{B}
\end{array} \right. 
\end{equation} 

\noindent oraz z wyra¿enia \ref{egn:20}, które pozwala zredukowaæ k¹t $\alpha $ do przedzia³u od 0 do $\pi/3$ \cite{bouanane2019design} :
\begin{equation} \label{egn:20}
\theta=\phi-\frac{k-1}{3}\pi 
\end{equation} 
gdzie: k - sektor {1..6}


\noindent mo¿na wyznaczyæ zale¿noœæ pozwalaj¹c¹ okreœliæ czasy $T_{A}$, $T_{B}$ generowania wektorów $V_{A}$, $V_{B}$ dla  dowolnego sektora \cite{bouanane2019design} :

\begin{equation} \label{egn:21}
\left\{ \begin{array}{ll}
T_{A} = \frac{\sqrt{3} T_{s} V_{x}}{V_{DC}} (sin(k\pi/3 - \theta))\\
T_{B} = \frac{\sqrt{3} T_{s} V_{x}}{V_{DC}} (sin((k-1)\pi/3 - \theta))
\end{array} \right. 
\end{equation} 


Suma czasów $T_{A}$, $T_{B}$ i $T_{0}$ jest równa okresowi modulacji szerokoœci impulsów $T_{S}$.

Znaj¹c sektor i czasy $T_{A}$, $T_{B}$, $T_{0}$ mo¿na wygenerowaæ dowolny wektor w przestrzeni stanu. Aby tego dokonaæ nale¿y zastosowaæ odpowiedni¹ sekwencjê za³¹czeñ wektorów $V_{A}$, $V_{B}$, $V_{0}$. Wektory te, w zale¿noœci od sektora, w którym siê znajduj¹, maj¹ swoj¹ reprezentacje w odpowiadaj¹cej im kombinacji za³¹czeñ kluczy tranzystorów przekszta³tnika.  Rysunek \ref{fig:13} przedstawia sekwencje wektorów $V_{A}$, $V_{B}$, $V_{0}$ i czasy ich aktywnoœci w zale¿noœci od umiejscowienia wektora referencyjnego w przestrzeni stanu. W wyniku powy¿szych operacji otrzymujemy trzy sygna³y PWM dla ka¿dej ga³êzi trójfazowego przekszta³tnika.

 \begin{figure}[H]
\centering
\includegraphics[width=10cm]{sektor.png}   
\caption{Sekwencja generowania wektora referencyjnego} 
\label{fig:13}
\end{figure} 


\section{Realizacja uk³adu napêdowego z silnikiem BLDC}
\subsection{Realizacja sprzêtowa}
Realizacja praktyczna uk³adu napêdowego jest przedstawiona na rysunku \ref{fig:14}.


 \begin{figure}[H]
\centering
\includegraphics[width=12cm]{naped1.png}   
\caption{Napêd z silnikiem BLDC}
\label{fig:14}
\end{figure} 





\subsection{Spis urz¹dzeñ}

\begin{enumerate}
\item Silnik bezszczotkowy FXD57BL 24 VDC
\item Przetwornik obrotowo-impulsowy N38G6-720-BM-8-30FG2
\item Zestaw rozwojowy STM32 B-G431B-ESC1
\item Zestaw rozwojowy STM32 Nucleo F746ZG
\item  Czujnik pr¹du Pololu 1185 ACS714 -5A : +5A
\item  Czujnik pr¹du Pololu 1185 ACS714 -5A : +5A
\item  Czujnik pr¹du Pololu 1185 ACS714 -5A : +5A
\item  Zasilacz laboratoryjny KORAD 0-30V, 0-5A
\end{enumerate}



\subsection{Schemat elektryczny}


 \begin{figure}[H]
\includegraphics[scale=0.65]{schemat_el.pdf}   
\label{fig:15}
\end{figure} 

\subsection{Opis i dane techniczne urz¹dzeñ}

\begin{enumerate}
\item Silnik bezszczotkowy FXD57BL 24 VDC

Silnik wykorzystany do budowy napêdu pokazany na rysunku \ref{fig:16}
 
Parametry techniczne:
\begin{itemize}
\item Moc: 60W
\item Napiêcie zasilania: 24 V
\item Pr¹d znamionowy: 3.3 A
\item Maksymalna prêdkoœæ obrotowa: 3000 obr/min
\item Moment znamionowy: 0,18 Nm
\item Wirnik dwupolowy 
\item D³ugoœæ silnika: 55 mm
\end{itemize}

 \begin{figure}[H]
\centering
\includegraphics[width=10cm]{silnik_bldc.png}   
\caption{Silnik BLDC}
\label{fig:16}
\end{figure} 



\item Inkrementalny przetwornik obrotowo-impulsowy N38G6-720-BM-8-30FG2

Przetwornik obrotowo-impulsowy inaczej enkoder jest czujnikiem mierz¹cym ruch. Przekszta³ca ruch obrotowy 
w sygna³ elektryczny o przebiegu prostok¹tnym. Enkoder inkrementalny nie generuje informacji o po³o¿eniu bezwzglêdnym.

\begin{itemize}
\item rozdzielczoœæ: 720 impulsów/obrót
\item napiêcie zasilania: 5 - 30 VDC
\item rodzaj wyjœcia: PUSH - PULL
\item maksymalny pobór pr¹du: 150 mA
\item maksymalne obci¹¿enie pr¹dowe:	30 mA
\item maksymalna czêstotliwoœæ:	150 kHz
\item znamionowa prêdkoœæ pracy:	5000 obr/min
\end{itemize}



\item Zestaw rozwojowy STM32 B-G431B-ESC1


Zestaw rozwojowy B-G431B-ESC1 firmy STMicroelectronics  oparty na mikrokontrolerze STM32G431CB jest dedykowanym uk³adem elektronicznym dla napêdów z silnikami BLDC/PMSM. Posiada przekszta³tnik energoelektroniczny zbudowany w oparciu o sterowniki L6387 i tranzystory mocy MOSFET STL180N6F7. Dla sterowania i monitorowania prac¹ silnika oraz do wspó³pracy  z innymi uk³adami zapewnia ró¿ne sposoby komunikacji  - UART, CAN i PWM. STM32G431CB wyposa¿ony w procesor  ARM Cortex M4 32-bity, pe³en zestaw instrukcji DSP (ang. Digital Signal Processing)   oraz blok do przetwarzania liczb zmiennoprzecinkowych FPU (ang. Floating-Point Unit) zapewnia mo¿liwoœæ implementacji ró¿nych zaawansowanych algorytmów sterowania. Posiada wbudowane uk³ady mierz¹ce pr¹d w silniku. Rysunek \ref{fig:17} przedstawia najistotniejsze elementy wbudowane w uk³ad B-G431B-ESC1.\cite{B-G431}



Parametry techniczne B-G431B-ESC1 \cite{B-G431}:
\begin{itemize}
\item napiêcie znamionowe 60 V
\item maksymalny pr¹d szczytowy (z uk³adem ch³odzenia): 40 A
\end{itemize}

Parametry techniczne STM32G431CB \cite{B-G431}:
\begin{itemize}
\item procesor: ARM Cortex M4 32-bity DSP
\item czêstotliwoœæ taktowania procesora: 170 MHz
\item Pamiêæ Flash: 128 KB
\item Pamiêæ SRAM: 32 KB
\item Przetwornik analogowo-cyfrowy 12-bitowy: 2
\item Komparatory: 4
\item Wbudowane wzmacniacze operacyjne: 3
\item Kontroler DMA
\item Interfejsy: UART, PWM, CAN
\end{itemize}


 \begin{figure}[H]
\centering
\includegraphics[width=14cm]{B-G431.png}   
\caption{Zestaw rozwojowy STM32 B-G431-ESC1 \cite{B-G431}}
\label{fig:17}
\end{figure} 

\item Zestaw rozwojowy STM32 Nucleo F746ZG

Nucleo F746ZG jest zestawem rozwojowym opartym na mikrokontrolerze STM32F746Z. Du¿a iloœæ peryferiów oraz wyprowadzonych pinów do ich pod³¹czenia zapewnia wiele mo¿liwoœci prototypownia. Posiada wbudowany programator ST-LINK/V2-1 oraz z³¹cze RJ-45 do po³¹czenia sieciowego. Rysunek \ref{fig:18} przedstawia  uk³ad 
Nucleo F746ZG.

Parametry techniczne mikrokontrolera STM32F746Z \cite{stm32f7}:

\begin{itemize}
\item procesor: ARM Cortex M7 32-bity FPU, DSP
\item czêstotliwoœæ taktowania procesora: 216 MHz
\item Pamiêæ Flash: 1 MB
\item Pamiêæ SRAM: 320 KB
\item przetwornik analogowo-cyfrowy 12-bitowy: 3
\item Liczniki: 18
\item przetwornik cyfrowo-analogowe 12-bitowy: 2
\item Interfejsy: UART,USART, $I^2 C$, SPI, CAN, SAIs, HDMI, USB
\item Kontroler DMA
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=8cm]{nucleo.png}   
\caption{Zestaw rozwojowy STM32 Nucleo F746ZG \cite{nucleo}}
\label{fig:18}
\end{figure} 
 


\end{enumerate}



\subsection{Implementacja uk³adu regulacji}

W zestawie rozwojowym B-G431-ESC zosta³ zaimplementowany uk³ad regulacji pr¹du, prêdkoœci i po³o¿enia dla napêdu z silnikiem BLDC przy wykorzystaniu metod FOC i SVPWM.
 
Do mierzenia pr¹dów fazowych zosta³y wykorzystane wbudowane, dedykowane uk³ady.  Mierzony jest spadek napiêcia na rezystorach umieszczonych miêdzy doln¹ grup¹ tranzystorów mocy a mas¹. Na rysunku  \ref{fig:19} przedstawiono sposób pomiaru. W wyniku bardzo ma³ej rezystancji wynosz¹cej 0.03 $\Omega$  sygna³ jest wzmacniany przez wzmacniacz operacyjny i za pomoc¹ przetwornika analogowo-cyfrowego uzyskiwane aktualne wartoœci pr¹dów - rysunek \ref{fig:20}.

 \begin{figure}[H]
\centering
\includegraphics[width=8cm]{current_sense.png}   
\caption{Pomiar pr¹du \cite{stspin32}}
\label{fig:19}
\end{figure} 

 \begin{figure}[H]
\centering
\includegraphics[width=8cm]{opamp.png}   
\caption{Wzmacnianie mierzonego sygna³u  \cite{stspin32}}
\label{fig:20}
\end{figure} 


Pomiar prêdkoœci  odbywa siê za pomoc¹ enkodera. Licznik skonfigurowany w trybie Mode Reset resetuje siê w momencie podania stanu wysokiego na jeden z kana³ów, do którego pod³¹czony jest enkoder. Znaj¹c czêstotliwoœæ  zliczania i okres miêdzy wyst¹pieniem dwóch stanów wysokich mo¿na w ³atwy sposób obliczyæ aktualn¹ prêdkoœæ.

Pomiar po³o¿enia wirnika równie¿ odbywa siê przy pomocy enkodera. Licznik w konfiguracji Encoder Mode zlicza wykryte zbocza z dwóch kana³ów, do których pod³¹czone s¹ dwa sygna³y z czujnika ruchu przesuniête w fazie. W zale¿noœci od kierunku obrotu licznik jest inkrementowany lub dekrementowany. Po zliczeniu iloœci impulsów równej rozdzielczoœci enkodera licznik zlicza od zera.

Biblioteka CMSIS-DSP udostêpnia szereg funkcji dla obliczeñ transformat, regulatorów PID oraz funkcji trygonometrycznych. Funkcja obliczaj¹ca wartoœæ sygna³u wyjœciowego regulatora PID ma postaæ \cite{cmsis}:
\\

 \textit{float32\_t   arm\_pid\_f32 (arm\_pid\_instance\_f32 *S, float32\_t in)}
\\
\\
gdzie:\\
float32\_t in – uchyb\\
arm\_pid\_instance\_f32 *S -  struktura [A0, A1, A2, Kp, Ki, Kd, state[3]] opisana wyra¿eniem \ref{egn:22}:\\

\begin{equation} \label{egn:22}
\left\{ \begin{array}{ll}
y[n] = y[n-1] + A0 * x[n] + A1 * x[n-1] + A2 * x[n-2]\\
   A0 = Kp + Ki + Kd\\
   A1 = (-Kp ) - (2 * Kd )\\
   A2 = Kd\\
\end{array} \right. 
\end{equation} 

\noindent Kp- wzmocnienie, Ki- sta³a ca³kowania, Kd- sta³a ró¿niczkowania
\vspace{0.4cm}

\noindent Rysunek poni¿ej reprezentuje schemat blokowy regulatora PID biblioteki CMSIS-DSP.

 \begin{figure}[H]
\centering
\includegraphics[width=8cm]{pid.png}   
\caption{Schemat regulatora PID biblioteki CMSIS-DSP \cite{cmsis}}
\label{fig:21}
\end{figure} 

Modulacja wektorowa SVPWM sk³ada siê z funkcji, które na podstawie zadanego wektora referencyjnego wyznacza trzy sygna³y  PWM oraz licznika skonfigurowanego w trybie PWM Center Mode z trzema kana³ami do wygenerowania sygna³ów PWM dla trzech par tranzystorów przekszta³tnika energoelektronicznego.  Dodatkowo czwarty kana³ przeznaczony jest do okreœlenia momentu uruchomienia przetwornika ADC i przypada on w po³owie okresu PWM, gdzie wszystkie tranzystory grupy dolnej s¹ w³¹czone a grupy górnej wy³¹czone. Na rysunku \ref{fig:22} przedstawiono synchronizacje wyzwalania przetwornika ADC z sygna³ami PWM.

 \begin{figure}[H]
\centering
\includegraphics[width=12cm]{synchronizacja.png}   
\caption{Synchronizacja sygan³u PWM z wyzwalaniem przerwania od przetwornika ADC}
\label{fig:22}
\end{figure} 
\vspace{0.4cm}

W funkcji obsu³gi przerwania od zdarzenia przetwornika ADC obliczane s¹ transformaty, funkcje regulatorów PID, transformaty odwrotne i funkcje modulacji wektorowej. W wyniku tych operacji, za pomoc¹ licznika z kana³ami steruj¹cymi bramkami tranzystorów przekszta³tnika, zostaj¹ wygenerowane trzy sygna³y PWM.


Do regulacji pr¹du, prêdkoœci i po³o¿enia zastosowano cztery regulatory PID oraz trzy pêtle regulacji. Po³¹czone ze sob¹ w sposób kaskadowy. Wynik regulatora zewnêtrznej pêtli wprowadzany jest na wejœcie regulatora wewnêtrznej pêtli. Schematycznie przedstawiono na rysunku \ref{fig:23}. Regulacja pr¹du dzia³a z najwy¿sz¹ czêstotliwoœci¹ 10kHz i jest w pêtli wewnêtrznej. Regulacja prêdkoœci odbywa siê z czêstotliwoœci¹ 5kHz. Regulator po³o¿enia znajdujê siê w pêtli zewnêtrznej i taktowany jest z czêstotliwoœci¹ 2kHz. 

 \begin{figure}[H]
\centering
\includegraphics[scale=0.7]{simulink.png}   
\caption{Model napêdu silnika BLDC}
\label{fig:23}
\end{figure} 
\vspace{0.4cm}



\section{Wnioski}



%% The List of Figures

\addcontentsline{toc}{section}{Wykaz ilustracji}
\listoffigures

\bibliographystyle{plain} %Style of Bibliography: plain / apalike / amsalpha / ...
\bibliography{bibl} %You need a~file 'literature.bib' for this.

\end{document}






